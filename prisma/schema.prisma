generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MASTER
  MANAGER
  RECRUITER
}

model Organization {
  id                String   @id @default(cuid())
  name              String   @unique
  avitoClientId     String?  // Avito API Client ID for the organization
  avitoClientSecret String?  // Avito API Client Secret
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  users             User[]
  customers         Customer[]
  candidates        Candidate[]
}

model User {
  id             String       @id @default(cuid())
  email          String       @unique
  hashedPassword String
  name           String?
  role           Role         @default(RECRUITER)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  ownedCustomers Customer[]
  ownedVacancies Vacancy[]
  activities     Activity[]
}

model Customer {
  id             String       @id @default(cuid())
  name           String
  inn            String?
  contactPerson  String?
  contactEmail   String?
  contactPhone   String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  ownerId        String?
  owner          User?        @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  vacancies      Vacancy[]
  activities     Activity[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, name])
}

model Vacancy {
  id             String    @id @default(cuid())
  title          String
  description    String?
  salaryMin      Int?
  salaryMax      Int?
  experience     String?   // "Без опыта", "1-3 года", "3-6 лет", "Более 6 лет"
  workFormat     String?   // "Удаленная работа", "Офис", "Гибрид"
  employmentType String?   // "Полная занятость", "Частичная занятость", "Проектная работа", "Стажировка"
  city           String?
  skills         String[]  @default([])
  status         String    @default("DRAFT") // DRAFT, ACTIVE, CLOSED, ARCHIVED
  
  // Avito Integration
  avitoId        String?      @unique
  avitoStatus    String?   // Status on Avito: created, activated, archived, blocked, closed, expired, rejected, unblocked
  avitoConfig    Json?     // Avito specific configuration, e.g. schedules, bonuses, etc.
  lastSyncAt     DateTime? // Дата последней синхронизации откликов с Avito

  // Relations
  customerId     String
  customer       Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  ownerId        String?
  owner          User?     @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  applications   VacancyApplication[]
  activities     Activity[]

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Candidate {
  id             String       @id @default(cuid())
  firstName      String
  lastName       String?
  phone          String?
  email          String?
  avitoResumeId  String?      // Resume ID on Avito or external
  resumeLink     String?      // Direct link to resume

  // Enriched from Avito applications/resumes
  age            Int?         // Возраст кандидата
  citizenship    String?      // Код гражданства ISO 3166-1 alpha-3 (rus, ukr, blr...)
  gender         String?      // "male" / "female"
  experienceYears String?     // "0", "lt_1", "1".."50"

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  applications   VacancyApplication[]
  activities     Activity[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model VacancyApplication {
  id           String    @id @default(cuid())
  vacancyId    String
  vacancy      Vacancy   @relation(fields: [vacancyId], references: [id], onDelete: Cascade)
  
  candidateId  String
  candidate    Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  status       String    @default("NEW") // NEW, SCREENING, INTERVIEW, OFFER, HIRED, REJECTED
  avitoApplyId     String?   @unique  // ID отклика на Avito
  isViewedOnAvito  Boolean   @default(false) // Помечен ли как просмотренный на Avito
  enrichedData     Json?               // Полные данные из enriched_properties Avito

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  @@unique([vacancyId, candidateId])
}

model Activity {
  id           String    @id @default(cuid())
  type         String    // e.g., "STATUS_CHANGE", "COMMENT", "EMAIL_SENT"
  details      String?   // e.g., "Candidate moved to Interview"

  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional relations depending on context
  candidateId  String?
  candidate    Candidate? @relation(fields: [candidateId], references: [id], onDelete: SetNull)

  vacancyId    String?
  vacancy      Vacancy?   @relation(fields: [vacancyId], references: [id], onDelete: SetNull)

  customerId   String?
  customer     Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)

  createdAt    DateTime  @default(now())
}
